<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Dealing with spatial data • climaemet</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="dealing_spatial_files/libs/quarto-html/popper.min.js"></script><script src="dealing_spatial_files/libs/quarto-html/tippy.umd.min.js"></script><link href="dealing_spatial_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="dealing_spatial_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Dealing with spatial data">
<meta property="og:image" content="https://ropenspain.github.io/climaemet/logo.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@mpizarrozgz">
<meta name="twitter:site" content="@rOpenSpain">
<!-- rogtemplate style sheet --><link href="../BS5/rostemplate.min.css" rel="stylesheet">
</head>
<body>
  <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


  <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html"><img src="../apple-touch-icon.png" alt="climaemet logo" height="34" width="34" class="d-inline-block me-1">climaemet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.5.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/climaemet.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/extending-climaemet.html">Extending climaemet</a></li>
    <li><a class="dropdown-item" href="../articles/aemet_stations.html">AEMET Stations</a></li>
    <li><a class="dropdown-item" href="../articles/api_metadata.html">API Metadata</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Predictions</h6></li>
    <li><a class="dropdown-item" href="../articles/interpolation.html">Spatial Interpolation with climaemet</a></li>
    <li><a class="dropdown-item" href="../articles/dealing_spatial.html">Dealing with spatial data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rOpenSpain/climaemet/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
    <div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Dealing with spatial data</h1>

      <p class="author">Gema Fernández-AvilésDiego Hernangómez</p>
      <p class="date">2026-02-18</p>

      <small class="dont-index">Source: <a href="https://github.com/rOpenSpain/climaemet/blob/main/vignettes/articles/dealing_spatial.qmd" class="external-link"><code>vignettes/articles/dealing_spatial.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="what-are-spatial-data">What are spatial data?<a class="anchor" aria-label="anchor" href="#what-are-spatial-data"></a>
</h2>
<p>Geospatial data are any data that contains information about a specific location on the Earth’s surface. Spatial data arise in a myriad of fields and applications, so there is also a wealth of spatial data types. <span class="citation" data-cites="cressie1993">Cressie (<a href="#ref-cressie1993" role="doc-biblioref">1993</a>)</span> provides a simple and useful classification of spatial data:</p>
<ol type="1">
<li>
<strong>Geostatistical data.</strong> For example, the level of (ln)CO in Madrid:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-intro1" class="quarto-float quarto-figure quarto-figure-center" data-fig-align="center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-intro1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="geo.png" class="quarto-figure quarto-figure-center" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-intro1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 1: Example of geostatistical data
</figcaption></figure>
</div>
</div>
</div>
<ol start="2" type="1">
<li>
<strong>Lattice data</strong>. For example, Organ donor rate by country.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-intro2" class="quarto-float quarto-figure quarto-figure-center" data-fig-align="center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-intro2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lattice.png" class="quarto-figure quarto-figure-center" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-intro2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 2: Example of lattice data
</figcaption></figure>
</div>
</div>
</div>
<ol start="3" type="1">
<li>
<strong>Point patterns.</strong> For example, deaths COVID, per day, in Spain.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-intro3" class="quarto-float quarto-figure quarto-figure-center" data-fig-align="center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-intro3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="point.gif" class="quarto-figure quarto-figure-center" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-intro3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 3: Example of point patterns
</figcaption></figure>
</div>
</div>
</div>
<p>See <span class="citation" data-cites="montero2015">Montero, Fernández-Avilés, and Mateu (<a href="#ref-montero2015" role="doc-biblioref">2015</a>)</span> for more details. In this work, we focus on geostatistical data.</p>
<section class="level2"><h3 id="what-do-we-need-to-carry-out-a-geostatistical-data-analysis-in-r">What do we need to carry out a geostatistical data analysis in R?<a class="anchor" aria-label="anchor" href="#what-do-we-need-to-carry-out-a-geostatistical-data-analysis-in-r"></a>
</h3>
<p>Some useful libraries we are going to use throughout this article are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ropenspain.github.io/climaemet/">climaemet</a></span><span class="op">)</span> <span class="co"># meteorological data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ropenspain.github.io/mapSpain/" class="external-link">mapSpain</a></span><span class="op">)</span> <span class="co"># base maps of Spain</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/classInt/" class="external-link">classInt</a></span><span class="op">)</span> <span class="co"># classification</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span> <span class="co"># raster handling</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span> <span class="co"># spatial shape handling</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/gstat/" class="external-link">gstat</a></span><span class="op">)</span> <span class="co"># for spatial interpolation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.leg.ufpr.br/geoR/" class="external-link">geoR</a></span><span class="op">)</span> <span class="co"># for spatial analysis</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span> <span class="co"># collection of R packages designed for data science</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/" class="external-link">tidyterra</a></span><span class="op">)</span> <span class="co"># tidyverse methods for terra package</span></span></code></pre></div>
</div>
</section><section class="level2"><h3 id="where-can-we-find-geostatistical-data">Where can we find geostatistical data?<a class="anchor" aria-label="anchor" href="#where-can-we-find-geostatistical-data"></a>
</h3>
<p>In this paper, we are going to deal with geostatistical data; specifically we are going to model the air temperature in Spain on <a href="https://en.wikipedia.org/wiki/Storm_Filomena" class="external-link"><strong>8 January 2021</strong></a>.</p>
<p>We download the data with <strong>climaemet (&gt;= 1.0.0)</strong> package <span class="citation" data-cites="pizarro2021">(<a href="#ref-pizarro2021" role="doc-biblioref">Pizarro, Hernangómez, and Fernández-Avilés 2021</a>)</span> in R. <strong>climaemet</strong> allows us to download the climatic data from the Spanish Meteorological Agency (AEMET) directly using their API. <strong>climaemet</strong> is available on <a href="https://CRAN.R-project.org/package=climaemet" class="external-link"><strong>CRAN</strong></a><strong>:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install climaemet</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"climaemet"</span><span class="op">)</span></span></code></pre></div>
</div>
<section class="level3"><h4 id="api-key">API Key<a class="anchor" aria-label="anchor" href="#api-key"></a>
</h4>
<p>To be able to download data from AEMET you will also need a free API key, which you can get <a href="https://opendata.aemet.es/centrodedescargas/obtencionAPIKey" class="external-link">here:</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ropenspain.github.io/climaemet/">climaemet</a></span><span class="op">)</span></span>
<span><span class="co"># Get api key from AEMET</span></span>
<span><span class="co"># browseURL("https://opendata.aemet.es/centrodedescargas/obtencionAPIKey")</span></span>
<span><span class="co"># Use this function to register your API Key temporarily or permanently</span></span>
<span><span class="co"># YOUR_API_KEY</span></span>
<span></span>
<span><span class="co"># aemet_api_key("YOUR_AEMET_API_KEY")</span></span></code></pre></div>
</section></section></section><section class="section level2"><h2 id="what-is-the-structure-of-geostatistical-data">What is the structure of geostatistical data?<a class="anchor" aria-label="anchor" href="#what-is-the-structure-of-geostatistical-data"></a>
</h2>
<p>Geostatistical data arises when the domain under study is a fixed set <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math> that is continuous. That is: (i) <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Z(s)</annotation></semantics></math> can be observed at any point of the domain (continuous); and (ii) the points in <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math> are non-stochastic (fixed, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math> is the same for all the realizations of the spatial random function).</p>
<p>First, take a look at the characteristics of the stations. We are interested in <strong>latitude</strong> and <strong>longitude</strong> attributes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stations</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aemet_stations.html">aemet_stations</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Have a look on the data</span></span>
<span><span class="va">stations</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">nombre</span>, latitude <span class="op">=</span> <span class="va">latitud</span>, longitude <span class="op">=</span> <span class="va">longitud</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"Preview of AEMET stations"</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<table class="table">
<caption>Preview of AEMET stations</caption>
<thead><tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: right;">latitude</th>
<th style="text-align: right;">longitude</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ESCORCA, LLUC</td>
<td style="text-align: right;">39.82333</td>
<td style="text-align: right;">2.885833</td>
</tr>
<tr class="even">
<td style="text-align: left;">SÓLLER, PUERTO</td>
<td style="text-align: right;">39.79556</td>
<td style="text-align: right;">2.691389</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BANYALBUFAR</td>
<td style="text-align: right;">39.68917</td>
<td style="text-align: right;">2.512778</td>
</tr>
<tr class="even">
<td style="text-align: left;">ANDRATX - SANT ELM</td>
<td style="text-align: right;">39.57944</td>
<td style="text-align: right;">2.368889</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CALVIÀ, ES CAPDELLÀ</td>
<td style="text-align: right;">39.55139</td>
<td style="text-align: right;">2.466389</td>
</tr>
<tr class="even">
<td style="text-align: left;">PALMA, PUERTO</td>
<td style="text-align: right;">39.55417</td>
<td style="text-align: right;">2.625278</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Next, we are going to extract the data. We select here the daily values of <a href="https://en.wikipedia.org/wiki/Storm_Filomena" class="external-link"><strong>8 January 2021</strong></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select data</span></span>
<span><span class="va">date_select</span> <span class="op">&lt;-</span> <span class="st">"2021-01-08"</span></span>
<span></span>
<span><span class="va">clim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aemet_daily.html">aemet_daily_clim</a></span><span class="op">(</span></span>
<span>  start <span class="op">=</span> <span class="va">date_select</span>,</span>
<span>  end <span class="op">=</span> <span class="va">date_select</span>,</span>
<span>  return_sf <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<p>Now, we examine the possible variables that can be analyzed. We are interested in <strong>minimum daily temperature</strong> named <code>tmin</code>, although the API also provides other interesting information:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clim_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "fecha"       "indicativo"  "nombre"      "provincia"   "altitud"    </span></span>
<span><span class="co">#&gt;  [6] "tmed"        "prec"        "tmin"        "horatmin"    "tmax"       </span></span>
<span><span class="co">#&gt; [11] "horatmax"    "hrMax"       "horaHrMax"   "hrMin"       "horaHrMin"  </span></span>
<span><span class="co">#&gt; [16] "hrMedia"     "dir"         "velmedia"    "racha"       "horaracha"  </span></span>
<span><span class="co">#&gt; [21] "presMax"     "horaPresMax" "presMin"     "horaPresMin" "sol"        </span></span>
<span><span class="co">#&gt; [26] "geometry"</span></span></code></pre></div>
</div>
<p>In this step, we select the variable of interest for each station. For simplicity, we would remove the Canary Islands in this exercise:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clim_data_clean</span> <span class="op">&lt;-</span> <span class="va">clim_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Exclude Canary Islands from analysis</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">provincia</span>, <span class="st">"PALMAS|TENERIFE"</span>, negate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">fecha</span>, <span class="va">tmin</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Exclude NAs</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tmin</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot with outline of Spain</span></span>
<span><span class="va">esp_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ropenspain.github.io/mapSpain/reference/esp_get_ccaa.html" class="external-link">esp_get_ccaa</a></span><span class="op">(</span>epsg <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Exclude Canary Islands from analysis</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ine.ccaa.name</span> <span class="op">!=</span> <span class="st">"Canarias"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Group the whole country</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">esp_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">clim_data_clean</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"AEMET Stations in Spain"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"excluding Canary Islands"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span></span>
<span>      size <span class="op">=</span> <span class="fl">12</span>,</span>
<span>      face <span class="op">=</span> <span class="st">"bold"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span></span>
<span>      size <span class="op">=</span> <span class="fl">8</span>,</span>
<span>      face <span class="op">=</span> <span class="st">"italic"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-selecttemp" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-selecttemp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-selecttemp-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-selecttemp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 4: AEMET stations in Spain (excl. Canary Islands)
</figcaption></figure>
</div>
</div>
</div>
<p>Now, let’s plot the values as a choropleth map:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This would be common to all the paper</span></span>
<span><span class="va">br_paper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">2.5</span><span class="op">)</span>, <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="va">pal_paper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">15</span>, <span class="st">"PuOr"</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">clim_data_clean</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">esp_sf</span>, fill <span class="op">=</span> <span class="st">"grey95"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">tmin</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">4</span>, alpha <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Min. temp"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>    colours <span class="op">=</span> <span class="va">pal_paper</span>,</span>
<span>    breaks <span class="op">=</span> <span class="va">br_paper</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_number.html" class="external-link">label_number</a></span><span class="op">(</span>suffix <span class="op">=</span> <span class="st">"°"</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="st">"legend"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Minimum temperature"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date_select</span><span class="op">)</span>, <span class="st">"%d %b %Y"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span></span>
<span>      size <span class="op">=</span> <span class="fl">12</span>,</span>
<span>      face <span class="op">=</span> <span class="st">"bold"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span></span>
<span>      size <span class="op">=</span> <span class="fl">8</span>,</span>
<span>      face <span class="op">=</span> <span class="st">"italic"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-choro" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-choro-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-choro-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-choro-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 5: Choropleth map with temperatures in Spain as of January 08, 2021
</figcaption></figure>
</div>
</div>
</div>
</section><section class="section level2"><h2 id="are-the-observations-independent-or-do-they-exhibit-spatial-dependence">Are the observations independent or do they exhibit spatial dependence?<a class="anchor" aria-label="anchor" href="#are-the-observations-independent-or-do-they-exhibit-spatial-dependence"></a>
</h2>
<p>The First Law of Geography states that <em>Everything is related to everything else. But near things are more related than distant things</em> <span class="citation" data-cites="tobler1969">(<a href="#ref-tobler1969" role="doc-biblioref">Tobler 1969</a>)</span>. This law is the basis of the fundamental concepts of <strong>spatial dependence</strong> and <strong>spatial autocorrelation</strong>.</p>
<p>In our study, we can observe <strong>positive spatial dependence</strong>: high temperature values are all found together in the south of Spain and low temperatures are found together in the north of Spain.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clim_data_clean</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">tmin</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      min <span class="op">=</span> <span class="va">min</span>,</span>
<span>      max <span class="op">=</span> <span class="va">max</span>,</span>
<span>      median <span class="op">=</span> <span class="va">median</span>,</span>
<span>      sd <span class="op">=</span> <span class="va">sd</span>,</span>
<span>      n <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      q25 <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fl">.25</span><span class="op">)</span>,</span>
<span>      q75 <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">.75</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    .names <span class="op">=</span> <span class="st">"{.fn}"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<table class="table">
<thead><tr class="header">
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">q25</th>
<th style="text-align: right;">q75</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">-15.1</td>
<td style="text-align: right;">13.6</td>
<td style="text-align: right;">-1.6</td>
<td style="text-align: right;">5.616639</td>
<td style="text-align: right;">743</td>
<td style="text-align: right;">-5.3</td>
<td style="text-align: right;">2.85</td>
</tr></tbody>
</table>
</div>
</div>
<p>In the next plot, we divide the minimum temperature into quartiles to visualize the spatial distribution of values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bubble</span> <span class="op">&lt;-</span> <span class="va">clim_data_clean</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">tmin</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create quartiles</span></span>
<span><span class="va">cuart</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/classInt/reference/classIntervals.html" class="external-link">classIntervals</a></span><span class="op">(</span><span class="va">bubble</span><span class="op">$</span><span class="va">tmin</span>, n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bubble</span><span class="op">$</span><span class="va">quart</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span></span>
<span>  <span class="va">bubble</span><span class="op">$</span><span class="va">tmin</span>,</span>
<span>  breaks <span class="op">=</span> <span class="va">cuart</span><span class="op">$</span><span class="va">brks</span>,</span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Q"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">bubble</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">quart</span>, fill <span class="op">=</span> <span class="va">quart</span><span class="op">)</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"grey20"</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    shape <span class="op">=</span> <span class="fl">21</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_size_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2.5</span>, <span class="fl">3</span>, <span class="fl">3.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"PuOr"</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Minimum temperature - Quartile map"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date_select</span><span class="op">)</span>, <span class="st">"%d %b %Y"</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Quartile"</span>,</span>
<span>    size <span class="op">=</span> <span class="st">"Quartile"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-bubbleplot" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-bubbleplot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-bubbleplot-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bubbleplot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 6: Bubble map representing the minimum temperatures in Spain (2021- 01-08)
</figcaption></figure>
</div>
</div>
</div>
</section><section class="section level2"><h2 id="preparing-the-data-as-a-spatial-object">Preparing the data as a spatial object<a class="anchor" aria-label="anchor" href="#preparing-the-data-as-a-spatial-object"></a>
</h2>
<p><strong>An important thing to consider in any spatial analysis or visualization</strong> is the <a href="https://en.wikipedia.org/wiki/Spatial_reference_system" class="external-link">coordinate reference system (CRS)</a>. In this exercise, we choose to project our objects to ETRS89 / UTM zone 30N <a href="https://epsg.io/25830" class="external-link">EPSG:25830</a>, which provides projected x and y values in meters and maximizes the accuracy for Spain.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clim_data_utm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">clim_data_clean</span>, <span class="fl">25830</span><span class="op">)</span></span>
<span></span>
<span><span class="va">esp_sf_utm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">esp_sf</span>, <span class="fl">25830</span><span class="op">)</span></span></code></pre></div>
</div>
<section class="level2"><h3 id="creating-a-grid-for-the-spatial-prediction">Creating a grid for the spatial prediction<a class="anchor" aria-label="anchor" href="#creating-a-grid-for-the-spatial-prediction"></a>
</h3>
<p>To predict values at locations where no measurements have been made, we need to create a grid of locations and perform an interpolation. On this article we are going to use the terra package for working with spatial grids (<code>SpatRaster</code> objects). <span class="citation" data-cites="hijmans2023">Hijmans and Ghosh (<a href="#ref-hijmans2023" role="doc-biblioref">2023</a>)</span> provides a detailed explanation on how to perform spatial interpolation using <strong>terra</strong> and <strong>gstat</strong> packages.</p>
<p>This grid is composed of equally spaced points over the whole (bounding box) of Spain. Most of the squares do not have any stations, so no observation observations are. However, we use the values of the cells that contain stations to interpolate the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create grid 5*5 km (25 km2)</span></span>
<span><span class="co"># The resolution in set based on the unit of the projection, in this case meters</span></span>
<span><span class="va">grd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">esp_sf_utm</span><span class="op">)</span>, res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="fl">5000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/cellSize.html" class="external-link">cellSize</a></span><span class="op">(</span><span class="va">grd</span><span class="op">)</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; size        : 193, 228, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 5000, 5000  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -13882.95, 1126117, 3892802, 4857802  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : ETRS89 / UTM zone 30N (EPSG:25830) </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span>
<span><span class="co">#&gt; name        :     area </span></span>
<span><span class="co">#&gt; min value   : 24785392 </span></span>
<span><span class="co">#&gt; max value   : 25019998</span></span></code></pre></div>
</div>
<p>There are some additional steps that we must perform in order to prepare our data for spatial interpolation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># There are some points duplicated, we need to remove those</span></span>
<span></span>
<span><span class="va">clim_data_clean_nodup</span> <span class="op">&lt;-</span> <span class="va">clim_data_utm</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">geometry</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">clim_data_utm</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 743</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">clim_data_clean_nodup</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 737</span></span>
<span></span>
<span><span class="va">clim_data_clean_nodup</span></span>
<span><span class="co">#&gt; Simple feature collection with 737 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -13501.2 ymin: 3903695 xmax: 1126597 ymax: 4858794</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 30N</span></span>
<span><span class="co">#&gt; # A tibble: 737 × 3</span></span>
<span><span class="co">#&gt;    fecha       tmin           geometry</span></span>
<span><span class="co">#&gt;    &lt;date&gt;     &lt;dbl&gt;        &lt;POINT [m]&gt;</span></span>
<span><span class="co">#&gt;  1 2021-01-08   4.2 (672170.6 4229216)</span></span>
<span><span class="co">#&gt;  2 2021-01-08   0.4 (974469.6 4626714)</span></span>
<span><span class="co">#&gt;  3 2021-01-08   5.9 (342907.5 4117910)</span></span>
<span><span class="co">#&gt;  4 2021-01-08  -7.6 (246984.3 4576961)</span></span>
<span><span class="co">#&gt;  5 2021-01-08   0.1 (740805.4 4456820)</span></span>
<span><span class="co">#&gt;  6 2021-01-08  -9.7 (433670.8 4553921)</span></span>
<span><span class="co">#&gt;  7 2021-01-08   1.3 (691017.1 4333929)</span></span>
<span><span class="co">#&gt;  8 2021-01-08   0.6 (179243.6 4231942)</span></span>
<span><span class="co">#&gt;  9 2021-01-08  -4.9 (227110.4 4495959)</span></span>
<span><span class="co">#&gt; 10 2021-01-08   3.8   (714492 4319880)</span></span>
<span><span class="co">#&gt; # ℹ 727 more rows</span></span></code></pre></div>
</div>
</section></section><section class="section level2"><h2 id="structural-analysis-of-the-spatial-dependence">Structural analysis of the spatial dependence<a class="anchor" aria-label="anchor" href="#structural-analysis-of-the-spatial-dependence"></a>
</h2>
<section class="level2"><h3 id="exploratory-spatial-data-analysis-esda">Exploratory Spatial Data Analysis (ESDA)<a class="anchor" aria-label="anchor" href="#exploratory-spatial-data-analysis-esda"></a>
</h3>
<p>Exploratory Data Analysis (EDA) is the first important step of data modeling, so ESDA is also the first step in spatial statistics. <strong>What do the data tell me about the relationship between <code>X</code> and <code>Y</code> coordinates and the variable <code>tmin</code> ?</strong></p>
<p>In order to answer this question, we summarize our spatial object and we observe a summary of: (i) the number of data points, (ii) the coordinates, (iii) the distance and (iv) the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clim_data_clean_nodup_geor</span> <span class="op">&lt;-</span> <span class="va">clim_data_clean_nodup</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">clim_data_clean_nodup</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/geoR/man/as.geodata.html" class="external-link">as.geodata</a></span><span class="op">(</span>coords.col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, data.col <span class="op">=</span> <span class="st">"tmin"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">clim_data_clean_nodup_geor</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of data points: 737 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coordinates summary</span></span>
<span><span class="co">#&gt;             X       Y</span></span>
<span><span class="co">#&gt; min  -13501.2 3903695</span></span>
<span><span class="co">#&gt; max 1126597.2 4858794</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Distance summary</span></span>
<span><span class="co">#&gt;          min          max </span></span>
<span><span class="co">#&gt; 2.252607e+01 1.187437e+06 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data summary</span></span>
<span><span class="co">#&gt;       Min.    1st Qu.     Median       Mean    3rd Qu.       Max. </span></span>
<span><span class="co">#&gt; -15.100000  -5.300000  -1.600000  -1.393894   2.900000  13.600000</span></span></code></pre></div>
</div>
<p>Second, we generate several exploratory geostatistical plots. The first is a quartile map, the next two show <code>tmin</code> against the <code>X</code> and <code>Y</code> coordinates and the last is an histogram of the <code>tmin</code> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">clim_data_clean_nodup_geor</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-ESDA_plot" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-ESDA_plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-ESDA_plot-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ESDA_plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 7: Example of Exploratory Spatial Data Analysis
</figcaption></figure>
</div>
</div>
</div>
<p>Looking the histogram, we see the data set is Gaussian! Note that kriging provides the Best Linear Unbiased Predictor <a href="https://en.wikipedia.org/wiki/Best_linear_unbiased_prediction" class="external-link">BLUP</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">clim_data_clean_nodup</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">tmin</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">tmin</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey40"</span>,</span>
<span>    binwidth <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">pal_paper</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"n obs."</span>, x <span class="op">=</span> <span class="st">"Min. temp (°)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Histogram - Minimum temperature"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date_select</span><span class="op">)</span>, <span class="st">"%d %b %Y"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-hist" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-hist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-hist-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 8: Histogram of minimum temperatures in Spain (2021-01-08)
</figcaption></figure>
</div>
</div>
</div>
</section><section class="level2"><h3 id="the-semivariogram">The semivariogram<a class="anchor" aria-label="anchor" href="#the-semivariogram"></a>
</h3>
<p>The <strong>semivariogram</strong> function is the keystone of geostatistical prediction. So, following <span class="citation" data-cites="montero2015">Montero, Fernández-Avilés, and Mateu (<a href="#ref-montero2015" role="doc-biblioref">2015</a>)</span> we formulate this question: <strong>How do we express in a function the structure of the spatial dependence or correlation present in the realization observed?</strong> The answer to this question, known in the geostatistics literature as the structural analysis of the spatial dependence, or, simply, <em>the structural analysis</em>, is a key issue in the subsequent process of optimal prediction (kriging), as the success of the kriging methods depends on the functions yielding information about the spatial dependence detected.</p>
<p>The functions referred to above are covariance functions and semivariograms, but <strong>they must meet a series of requisites.</strong> As we only have the observed realization, in practice, the covariance functions and semivariograms derived from it may not satisfy these requisites. For this reason, <strong>one of the theoretical models (also called the valid models) that do comply must be fitted to it.</strong></p>
<p>There are some packages in R to carry out a geostatistical analysis but there are “the big two”: <strong>geoR</strong> <span class="citation" data-cites="ribeirojr2001">(<a href="#ref-ribeirojr2001" role="doc-biblioref">Ribeiro Jr and Diggle 2001</a>)</span> and <strong>gstat</strong> <span class="citation" data-cites="pebesma2004 graler2016">(<a href="#ref-pebesma2004" role="doc-biblioref">Pebesma 2004</a>; <a href="#ref-graler2016" role="doc-biblioref">Gräler, Pebesma, and Heuvelink 2016</a>)</span>.</p>
<p>The <strong>semivariogram</strong> is, generally, a non-decreasing monotone function, so that the variability of the first increments of the random functions increases with distance.</p>
<p>We are going to generate the (omnidirectional) empirical semivariogram of our data, which, in a second step, has to be fitted to a theoretical one.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vario_geor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/geoR/man/variog.html" class="external-link">variog</a></span><span class="op">(</span></span>
<span>  <span class="va">clim_data_clean_nodup_geor</span>,</span>
<span>  coords <span class="op">=</span> <span class="va">clim_data_clean_nodup_geor</span><span class="op">$</span><span class="va">coords</span>,</span>
<span>  data <span class="op">=</span> <span class="va">clim_data_clean_nodup_geor</span><span class="op">$</span><span class="va">data</span>,</span>
<span>  uvec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000000</span>, l <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; variog: computing omnidirectional variogram</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vario_geor</span>, pch <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-variog_geoR" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-variog_geoR-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-variog_geoR-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-variog_geoR-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 9: Semivariogram
</figcaption></figure>
</div>
</div>
</div>
<p><code><a href="https://rdrr.io/pkg/geoR/man/eyefit.html" class="external-link">eyefit()</a></code> is an interactive function that fits the parameters of the semivariogram by eye. It is an intuitive function to play with the types and parameters of the semivariogram. It can help you to fit the empirical semivariogram to a theoretical one. Of course, there are other statistical methods to fit the semivariogram: Ordinary Least Squares (OLS), Weighted Least Squares (WLS), Maximum Likelihood (ML), Restricted Maximum Likelihood (REML).</p>
<p>Run it on your PC!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/geoR/man/eyefit.html" class="external-link">eyefit</a></span><span class="op">(</span><span class="va">vario_geor</span><span class="op">)</span></span></code></pre></div>
</div>
<p>With <code><a href="https://rdrr.io/pkg/geoR/man/eyefit.html" class="external-link">geoR::eyefit()</a></code> we have observed that there <strong>different types of semivariograms</strong> and each type contains <strong>several parameters</strong> that have to be fitted.</p>
<p>The main types of semivariograms are:</p>
<ul>
<li><em>Spherical</em></li>
<li><em>Exponential</em></li>
<li><em>Gaussian</em></li>
<li><em>Hole Effect</em></li>
<li><em>K-Bessel</em></li>
<li><em>J-Bessel</em></li>
<li><em>Stable</em></li>
<li><em>Mattern</em></li>
<li><em>Circular</em></li>
<li><em>Nugget</em></li>
</ul>
<p>A graphical summary of the most common <strong>spatial semivariogram models</strong> can be found here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/gstat/reference/show.vgms.html" class="external-link">show.vgms</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-semi_models" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-semi_models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-semi_models-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-semi_models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 10: Summary of common spatial semivariograms
</figcaption></figure>
</div>
</div>
</div>
<p>Regarding the <strong>parameters</strong>, the main ones are:</p>
<ul>
<li>
<em>Sill</em>: is defined as the a priori variance of the random function.</li>
<li>
<em>Range</em>: is the distance at which the sill is reached, which defines the threshold of spatial dependence.</li>
<li>
<em>Nugget</em>: The value at which the semivariogram intercepts the y-value. Theoretically, at zero separation distance, the semivariogram value is 0. The nugget effect can be attributed to measurement errors or spatial sources of variation at distances smaller than the sampling interval or both.</li>
</ul>
<p>For a detailed study of the semivariogram function see <span class="citation" data-cites="montero2015">Montero, Fernández-Avilés, and Mateu (<a href="#ref-montero2015" role="doc-biblioref">2015</a>)</span>.</p>
<p>Now, we plot the empirical semivariogram of our data (again) with <code><a href="https://r-spatial.github.io/gstat/reference/variogram.html" class="external-link">gstat::variogram</a></code> and we check the semivariogram in four directions (0°, 45°, 90°, 135°).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vgm_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogram.html" class="external-link">variogram</a></span><span class="op">(</span></span>
<span>  <span class="va">tmin</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  <span class="va">clim_data_clean_nodup</span>,</span>
<span>  cutoff <span class="op">=</span> <span class="fl">1000000</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">45</span>, <span class="fl">90</span>, <span class="fl">135</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vgm_dir</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-variog_gstat" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-variog_gstat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-variog_gstat-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-variog_gstat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 11: Directional empirical semivariogram in gstat()
</figcaption></figure>
</div>
</div>
</div>
<p>We can see that all the semivariograms exhibit spatial dependence. We choose the 90° semivariogram.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vgm_dir_selected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogram.html" class="external-link">variogram</a></span><span class="op">(</span></span>
<span>  <span class="va">tmin</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  <span class="va">clim_data_clean_nodup</span>,</span>
<span>  cutoff <span class="op">=</span> <span class="fl">1000000</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">90</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<p>Now, we fit the empirical semivariogram to a theoretical semivariogram, which is included in the kriging equations. Note that, in our case, the object <code>fit_var</code> contains the value of the estimated parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/fit.variogram.html" class="external-link">fit.variogram</a></span><span class="op">(</span><span class="va">vgm_dir_selected</span>, model <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/vgm.html" class="external-link">vgm</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Sph"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_var</span></span>
<span><span class="co">#&gt;   model    psill    range</span></span>
<span><span class="co">#&gt; 1   Sph 50.11476 892488.4</span></span></code></pre></div>
</div>
<p>Finally, we plot the empirical and the theoretical semivariograms together.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">vgm_dir_selected</span>,</span>
<span>  <span class="va">fit_var</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Empirical (dots) and theoretical (line) semivariograms "</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-variog_gstat_fit" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-variog_gstat_fit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-variog_gstat_fit-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-variog_gstat_fit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 12: Empirical (dots) and theoretical (line) semivariograms
</figcaption></figure>
</div>
</div>
</div>
</section></section><section class="section level2"><h2 id="carrying-out-ordinary-kriging">Carrying out Ordinary Kriging<a class="anchor" aria-label="anchor" href="#carrying-out-ordinary-kriging"></a>
</h2>
<p>Once a theoretical semivariogram has been chosen, we are ready for spatial prediction. The method geostatistics uses for spatial prediction is termed kriging in honor of the South African mining engineer, Daniel Gerhardus Krige.</p>
<p>According to <span class="citation" data-cites="montero2015">Montero, Fernández-Avilés, and Mateu (<a href="#ref-montero2015" role="doc-biblioref">2015</a>)</span>, <strong>kriging</strong> aims to predict the value of a random function, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Z(s)</annotation></semantics></math>, at one or more non-observed points (or blocks) from a collection of data observed at <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math> points (or blocks in the case of block prediction) of a domain <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>, and provides the best linear unbiased predictor (BLUP) of the regionalized variable under study at such non-observed points or blocks</p>
<p>There are different kinds of kriging depend on the characteristics of the spatial process: simple, ordinary or universal kriging (external drift kriging), kriging in a local neighborhood, point kriging or kriging of block mean values and conditional (Gaussian or indicator) simulation equivalents for all kriging varieties.</p>
<p>In this work we deal with ordinary kriging, the most widely-used kriging method. According to <span class="citation" data-cites="wackernagel1995">Wackernagel (<a href="#ref-wackernagel1995" role="doc-biblioref">1995</a>)</span> it serves to estimate a value at a point of a region for which a variogram is known, using data in the neighborhood of the estimation location.</p>
<p>In this study, we perform ordinary kriging (OK) following <span class="citation" data-cites="hijmans2023">Hijmans and Ghosh (<a href="#ref-hijmans2023" role="doc-biblioref">2023</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Need to pass the input as data frame</span></span>
<span><span class="va">clim_data_clean_nodup_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">clim_data_clean_nodup</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"XY"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clim_data_clean_nodup_df</span></span>
<span><span class="co">#&gt; # A tibble: 737 × 4</span></span>
<span><span class="co">#&gt;    fecha       tmin       x        y</span></span>
<span><span class="co">#&gt;    &lt;date&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 2021-01-08   4.2 672171. 4229216.</span></span>
<span><span class="co">#&gt;  2 2021-01-08   0.4 974470. 4626714.</span></span>
<span><span class="co">#&gt;  3 2021-01-08   5.9 342908. 4117910.</span></span>
<span><span class="co">#&gt;  4 2021-01-08  -7.6 246984. 4576961.</span></span>
<span><span class="co">#&gt;  5 2021-01-08   0.1 740805. 4456820.</span></span>
<span><span class="co">#&gt;  6 2021-01-08  -9.7 433671. 4553921.</span></span>
<span><span class="co">#&gt;  7 2021-01-08   1.3 691017. 4333929.</span></span>
<span><span class="co">#&gt;  8 2021-01-08   0.6 179244. 4231942.</span></span>
<span><span class="co">#&gt;  9 2021-01-08  -4.9 227110. 4495959.</span></span>
<span><span class="co">#&gt; 10 2021-01-08   3.8 714492. 4319880.</span></span>
<span><span class="co">#&gt; # ℹ 727 more rows</span></span>
<span></span>
<span><span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/gstat.html" class="external-link">gstat</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">tmin</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  locations <span class="op">=</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span>,</span>
<span>  data <span class="op">=</span> <span class="va">clim_data_clean_nodup_df</span>,</span>
<span>  model <span class="op">=</span> <span class="va">fit_var</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">kriged</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/interpolate.html" class="external-link">interpolate</a></span><span class="op">(</span><span class="va">grd</span>, <span class="va">k</span>, debug.level <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Now, we plot the kriging prediction:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">esp_sf_utm</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">kriged</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">var1.pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>    colours <span class="op">=</span> <span class="va">pal_paper</span>,</span>
<span>    breaks <span class="op">=</span> <span class="va">br_paper</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_number.html" class="external-link">label_number</a></span><span class="op">(</span>suffix <span class="op">=</span> <span class="st">"°"</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span></span>
<span>      reverse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      title <span class="op">=</span> <span class="st">"Min. temp\n(kriged)"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Ordinary Kriging - Minimum temperature"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date_select</span><span class="op">)</span>, <span class="st">"%d %b %Y"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">pred</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-krig_plot1" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-krig_plot1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-krig_plot1-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-krig_plot1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 13: Ordinary Kriging - Minimum temperature
</figcaption></figure>
</div>
</div>
</div>
<p>And, the variance of the prediction:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">esp_sf_utm</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spat_contour.html" class="external-link">geom_spatraster_contour_filled</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">kriged</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">var1.var</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">8</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="cn">Inf</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">clim_data_clean_nodup</span>, colour <span class="op">=</span> <span class="st">"blue"</span>, shape <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_whitebox.html" class="external-link">scale_fill_whitebox_d</a></span><span class="op">(</span></span>
<span>    palette <span class="op">=</span> <span class="st">"pi_y_g"</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.7</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Variance"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"OK prediction variance - Minimum temperature"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date_select</span><span class="op">)</span>, <span class="st">"%d %b %Y"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-krig_plot2" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-krig_plot2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-krig_plot2-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-krig_plot2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 14: OK prediction variance - Minimum temperature
</figcaption></figure>
</div>
</div>
</div>
<p>Lastly, we plot the variance and the prediction together:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">clim_data_clean_nodup</span>, colour <span class="op">=</span> <span class="st">"darkred"</span>, shape <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spat_contour.html" class="external-link">geom_spatraster_contour</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">kriged</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">var1.var</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.5</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"OK: Prediction and variance prediction"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Points: Climate stations.\nLines: Cluster of variances"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-predandvar" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-predandvar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-predandvar-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-predandvar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 15: OK: Prediction and variance prediction
</figcaption></figure>
</div>
</div>
</div>
<p>It can be seen that in the areas near to the observed points the prediction variance is minimal; on the contrary, in the areas where no monitoring stations can be found the prediction variance is bigger.</p>
</section><section class="section level2"><h2 id="comparing-ordinary-kriging-with-inverse-distance-weighting">Comparing Ordinary Kriging with Inverse Distance Weighting<a class="anchor" aria-label="anchor" href="#comparing-ordinary-kriging-with-inverse-distance-weighting"></a>
</h2>
<p>In this section, we compare Ordinary Kriging (OK) vs. the Inverse Distance Weighting (<strong>IDW</strong>) method, which is one of several approaches to perform spatial interpolation. Once again we would apply the approach described in <span class="citation" data-cites="hijmans2023">Hijmans and Ghosh (<a href="#ref-hijmans2023" role="doc-biblioref">2023</a>)</span> on how to perform these analysis in <strong>R</strong> with <strong>terra</strong>.</p>
<p>Note that IDW is a deterministic interpolation technique that creates surfaces from sample points using mathematical functions (it is assumed that the correlation can be defined as a reverse distance function of every point from neighboring points). On the contrary, stochastics interpolation techniques, like kriging, utilize the statistical properties of the sample points (<strong>based on the variogram which gives the spatial structure of the studied variable</strong>). Moreover, kriging provides the error prediction map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/gstat.html" class="external-link">gstat</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">tmin</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  locations <span class="op">=</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span>,</span>
<span>  data <span class="op">=</span> <span class="va">clim_data_clean_nodup_df</span>,</span>
<span>  set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>idp <span class="op">=</span> <span class="fl">2.0</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">idw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/interpolate.html" class="external-link">interpolate</a></span><span class="op">(</span><span class="va">grd</span>, <span class="va">gs</span><span class="op">)</span></span>
<span><span class="co">#&gt; [inverse distance weighted interpolation]</span></span>
<span><span class="co">#&gt; [inverse distance weighted interpolation]</span></span>
<span></span>
<span></span>
<span><span class="co"># Now we create a SpatRaster with two layers, one prediction each</span></span>
<span></span>
<span><span class="va">all_methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="va">kriged</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>Kriging <span class="op">=</span> <span class="va">var1.pred</span><span class="op">)</span>,</span>
<span>  <span class="va">idw</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>IDW <span class="op">=</span> <span class="va">var1.pred</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot and compare</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">esp_sf_utm</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">all_methods</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>    colours <span class="op">=</span> <span class="va">pal_paper</span>,</span>
<span>    n.breaks <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_number.html" class="external-link">label_number</a></span><span class="op">(</span>suffix <span class="op">=</span> <span class="st">"°"</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span></span>
<span>      title <span class="op">=</span> <span class="st">"Min. temp"</span>,</span>
<span>      direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>      keyheight <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>      keywidth <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>      title.hjust <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>      label.hjust <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>      nrow <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      byrow <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      reverse <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      label.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"OK vs IDW"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date_select</span><span class="op">)</span>, <span class="st">"%d %b %Y"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-idw" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-idw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-idw-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-idw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 16: Comparing Ordinary Kriging with Inverse Distance Weighting
</figcaption></figure>
</div>
</div>
</div>
<section class="level2"><h3 id="cross-validation">Cross-validation<a class="anchor" aria-label="anchor" href="#cross-validation"></a>
</h3>
<p>To compare the two interpolation methods, OK and IDW, we should to carry out a cross-validation (CV) or leave-one-out process. Moreover, CV is the most widely-used procedure to validate the semivariogram model selected in a kriging interpolation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Cross-validation: OK</span></span>
<span><span class="va">xv_ok</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/krige.cv.html" class="external-link">krige.cv</a></span><span class="op">(</span><span class="va">tmin</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">clim_data_clean_nodup</span>, <span class="va">fit_var</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xv_ok</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="va">min</span>, max <span class="op">=</span> <span class="va">max</span><span class="op">)</span>,</span>
<span>    .names <span class="op">=</span> <span class="st">"{.col}_{.fn}"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"field"</span>, <span class="st">"stat"</span><span class="op">)</span>, names_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">stat</span>, names_from <span class="op">=</span> <span class="va">field</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 7</span></span>
<span><span class="co">#&gt;   stat  var1.pred var1.var observed residual zscore  fold</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 min       -12.9  0.00379    -15.1    -8.24  -7.87     1</span></span>
<span><span class="co">#&gt; 2 max        14.2 17.6         13.6     6.69   7.77   737</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cross-validation: IDW</span></span>
<span><span class="va">xv_idw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/krige.cv.html" class="external-link">krige.cv</a></span><span class="op">(</span><span class="va">tmin</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">clim_data_clean_nodup</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xv_idw</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="va">min</span>, max <span class="op">=</span> <span class="va">max</span><span class="op">)</span>,</span>
<span>    .names <span class="op">=</span> <span class="st">"{.col}_{.fn}"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"field"</span>, <span class="st">"stat"</span><span class="op">)</span>, names_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">stat</span>, names_from <span class="op">=</span> <span class="va">field</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 7</span></span>
<span><span class="co">#&gt;   stat  var1.pred var1.var observed residual zscore  fold</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 min      -11.5        NA    -15.1    -9.48     NA     1</span></span>
<span><span class="co">#&gt; 2 max        9.59       NA     13.6    10.8      NA   737</span></span></code></pre></div>
</div>
<p>Now, we plot the leave-one-out cross validation residuals and observe that the residuals with OK are smaller than with OK.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create unique scale</span></span>
<span></span>
<span><span class="va">allvalues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">all_methods</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, mat <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare final data</span></span>
<span><span class="va">cross_val</span> <span class="op">&lt;-</span> <span class="va">xv_ok</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"OK"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">xv_idw</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"IDW"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">method</span>, <span class="va">residual</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>method <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span>, cat <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/cut_interval.html" class="external-link">cut_number</a></span><span class="op">(</span><span class="va">residual</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cross_val</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">esp_sf_utm</span>, fill <span class="op">=</span> <span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">cat</span>, size <span class="op">=</span> <span class="va">cat</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">21</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">method</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_size_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">1</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_whitebox.html" class="external-link">scale_fill_whitebox_d</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"pi_y_g"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Tmin: leave-one-out cross validation residuals"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"By Method"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">""</span>,</span>
<span>    size <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>,</span>
<span>    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="fig-crossval" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-crossval-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dealing_spatial_files/figure-html/fig-crossval-1.png" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crossval-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 17: Tmin: leave-one-out cross validation residuals
</figcaption></figure>
</div>
</div>
</div>
<p>Moreover, calculating the diagnostic statistics from the results it is a good way to select the best interpolation method. The error-based measures used in the study include the root-mean-square error (RMSE) and the mean error (ME).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">me</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">observed</span>, <span class="va">predicted</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">predicted</span> <span class="op">-</span> <span class="va">observed</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">rmse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">observed</span>, <span class="va">predicted</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">predicted</span> <span class="op">-</span> <span class="va">observed</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># OK Diagnostic statistics</span></span>
<span></span>
<span><span class="va">me_ok</span> <span class="op">&lt;-</span> <span class="fu">me</span><span class="op">(</span><span class="va">xv_ok</span><span class="op">$</span><span class="va">observed</span>, <span class="va">xv_ok</span><span class="op">$</span><span class="va">var1.pred</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rmse_ok</span> <span class="op">&lt;-</span> <span class="fu">rmse</span><span class="op">(</span><span class="va">xv_ok</span><span class="op">$</span><span class="va">observed</span>, <span class="va">xv_ok</span><span class="op">$</span><span class="va">var1.pred</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># IDw Diagnostic statistics</span></span>
<span></span>
<span><span class="va">me_idw</span> <span class="op">&lt;-</span> <span class="fu">me</span><span class="op">(</span><span class="va">xv_idw</span><span class="op">$</span><span class="va">observed</span>, <span class="va">xv_idw</span><span class="op">$</span><span class="va">var1.pred</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rmse_idw</span> <span class="op">&lt;-</span> <span class="fu">rmse</span><span class="op">(</span><span class="va">xv_idw</span><span class="op">$</span><span class="va">observed</span>, <span class="va">xv_idw</span><span class="op">$</span><span class="va">var1.pred</span><span class="op">)</span></span></code></pre></div>
</div>
<p>So, as we expected, we can see that OK yields better predictions than IDW.</p>
<div id="tbl-diag" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl"><div aria-describedby="tbl-diag-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="cell-output-display">
<table class="table">
<thead><tr class="header">
<th style="text-align: left;">Diagnostic statistics</th>
<th style="text-align: right;">ME</th>
<th style="text-align: right;">RMSE</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">OK</td>
<td style="text-align: right;">-0.028</td>
<td style="text-align: right;">1.659</td>
</tr>
<tr class="even">
<td style="text-align: left;">IDW</td>
<td style="text-align: right;">-0.042</td>
<td style="text-align: right;">2.256</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-tbl" id="tbl-diag-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table 1: Diagnostic statistics: OK vs. IDW
</figcaption></figure>
</div>
</section></section><section class="section level2"><h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-cressie1993" class="csl-entry" role="listitem">
Cressie, Noel A. C. 1993. <span>“Statistics for Spatial Data.”</span> In <em>Statistics for Spatial Data</em>, Rev. ed, 1–26. Wiley Series in Probability and Statistics. John Wiley &amp; Sons, Ltd. <a href="https://doi.org/10.1002/9781119115151.ch1" class="external-link">https://doi.org/10.1002/9781119115151.ch1</a>.
</div>
<div id="ref-graler2016" class="csl-entry" role="listitem">
Gräler, Benedikt, Edzer Pebesma, and Gerard Heuvelink. 2016. <span>“Spatio-Temporal Interpolation Using Gstat.”</span> <em>The R Journal</em> 8: 204–18. <a href="https://journal.r-project.org/archive/2016/RJ-2016-014/index.html" class="external-link">https://journal.r-project.org/archive/2016/RJ-2016-014/index.html</a>.
</div>
<div id="ref-hijmans2023" class="csl-entry" role="listitem">
Hijmans, Robert J., and Aniruddha Ghosh. 2023. <span>“Interpolation.”</span> In <em>Spatial Data Analysis with <span>R</span></em>, 31–54. Spatial Data Science with <span>R</span> and <span class="nocase">"terra"</span>. Online. <a href="https://rspatial.org/analysis/analysis.pdf" class="external-link">https://rspatial.org/analysis/analysis.pdf</a>.
</div>
<div id="ref-montero2015" class="csl-entry" role="listitem">
Montero, José-Marı́a, Gema Fernández-Avilés, and Jorge Mateu. 2015. <em>Spatial and Spatio<span>-</span>Temporal Geostatistical Modeling and Kriging</em>. Wiley Series in Probability and Statistics. Wiley. <a href="https://doi.org/10.1002/9781118762387" class="external-link">https://doi.org/10.1002/9781118762387</a>.
</div>
<div id="ref-pebesma2004" class="csl-entry" role="listitem">
Pebesma, Edzer J. 2004. <span>“Multivariable Geostatistics in <span>S</span>: The <span class="nocase">gstat</span> Package.”</span> <em>Computers &amp; Geosciences</em> 30: 683–91. <a href="https://doi.org/10.1016/j.cageo.2004.03.012" class="external-link">https://doi.org/10.1016/j.cageo.2004.03.012</a>.
</div>
<div id="ref-pizarro2021" class="csl-entry" role="listitem">
Pizarro, Manuel, Diego Hernangómez, and Gema Fernández-Avilés. 2021. <span>“<span class="nocase">climaemet</span>: Climate <span>AEMET</span> Tools.”</span> Zenodo. <a href="https://doi.org/10.5281/ZENODO.5512237" class="external-link">https://doi.org/10.5281/ZENODO.5512237</a>.
</div>
<div id="ref-ribeirojr2001" class="csl-entry" role="listitem">
Ribeiro Jr, Paulo Justiniano, and Peter Diggle. 2001. <span>“<span class="nocase">geoR</span>: Analysis of Geostatistical Data.”</span> The R Foundation. <a href="https://doi.org/10.32614/cran.package.geor" class="external-link">https://doi.org/10.32614/cran.package.geor</a>.
</div>
<div id="ref-tobler1969" class="csl-entry" role="listitem">
Tobler, Waldo R. 1969. <span>“Geographical Filters and Their Inverses.”</span> <em>Geographical Analysis</em> 1 (3): 234–53. <a href="https://doi.org/10.1111/j.1538-4632.1969.tb00621.x" class="external-link">https://doi.org/10.1111/j.1538-4632.1969.tb00621.x</a>.
</div>
<div id="ref-wackernagel1995" class="csl-entry" role="listitem">
Wackernagel, Hans. 1995. <span>“Ordinary Kriging.”</span> In <em>Multivariate Geostatistics: An Introduction with Applications</em>, 74–81. Springer Berlin Heidelberg. <a href="https://doi.org/10.1007/978-3-662-03098-1_11" class="external-link">https://doi.org/10.1007/978-3-662-03098-1_11</a>.
</div>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>

  </div>

  <!-- ropenspain rostemplate -->
<footer id="footer"><div class="container">
    <div class="row">
      <div class="col-md">
        <h4 data-toc-skip>About <img src="../logo.png" alt="climaemet Logo" height="24" class="round-logo">
          climaemet</h4>
        <p>Developed by <a href="https://github.com/mpizarrotig" class="external-link">Manuel Pizarro</a>, <a href="https://dieghernan.github.io/" class="external-link">Diego Hernangómez</a>, <a href="https://blog.uclm.es/gemafaviles/" class="external-link">Gema Fernández-Avilés</a>. <br>Part of the <span class="ROS-light">rOpenSpain</span> project.
</p>
        <hr class="d-md-none">
</div>
      <div class="col-md offset-md-4">
        <h4 data-toc-skip>About <img src="../ROS-logo.png" alt="ROpenSpain Logo" height="24" class="round-logo"><span class="ROS-light">
            rOpenSpain</span>
</h4>
        <p><a href="https://ropenspain.es/" class="external-link"><span class="ROS-light">rOpenSpain</span></a> is a community of
          enthusiasts
          of <strong>R</strong>, open data, and reproducibility that comes
          together and organizes itself to create <strong>R</strong> packages of
          the highest quality for the analysis
          and use of Spanish data of general interest.
        </p>
        <p class="fst-italic text-md-end">"rOpenSci is our form, Spanish public
          data our matter"</p>
        <hr class="d-md-none">
</div>
    </div>
  </div>
</footer><div id="copyright">
  <div class="container">
    <div class="row">
      <div class="col-md text-center text-md-start">
        <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
      </div>
      <div class="col-md offset-md-4 text-center text-md-start lh-base">
        <p>Template <a href="https://ropenspain.github.io/rostemplate/" class="external-link">rostemplate</a> by
          <a href="https://github.com/dieghernan/" class="external-link">dieghernan</a>, based on <a href="https://devcows.github.io/hugo-universal-theme/" class="external-link">Universal
            Theme for Hugo</a>.
        </p>
      </div>
    </div>
  </div>
</div>




  <script>
  var h1s = document.getElementsByTagName("h1");
  var myH1;
  if (h1s.length > 0) {
    myH1 = h1s[0];
    myH1.classList.add("ROSh1");
  }
</script>
</body>
</html>
